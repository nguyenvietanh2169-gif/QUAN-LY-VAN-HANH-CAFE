<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Cafe POS Pro - Camera Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/924/924514.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-active { color: #4f46e5 !important; font-weight: 800; }
        #camera-overlay { display: none; position: fixed; inset: 0; background: black; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 100%; max-width: 400px; border-radius: 20px; transform: scaleX(-1); }
    </style>
</head>
<body class="pb-24">

<div id="camera-overlay">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="mt-6 flex gap-4">
        <button onclick="takePhoto()" class="bg-white text-black px-8 py-3 rounded-full font-bold">CH·ª§P üì∏</button>
        <button onclick="closeCamera()" class="bg-red-500 text-white px-8 py-3 rounded-full font-bold">H·ª¶Y</button>
    </div>
</div>

<header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 px-6 py-4 flex justify-between items-center border-b shadow-sm">
    <h1 class="text-xl font-black text-indigo-600 tracking-tighter">SMART CAFE <span class="text-gray-400 font-normal">PRO</span></h1>
    <span id="headerTime" class="text-xs font-bold text-gray-400">00:00</span>
</header>

<main class="max-w-xl mx-auto p-4">

    <div id="pos" class="tab-content active-tab space-y-4">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100">
            <div id="menuGrid" class="grid grid-cols-3 gap-2 mb-4"></div>
            <div class="flex gap-2">
                <input type="text" id="customOrder" placeholder="Ghi ch√∫ m√≥n..." class="flex-1 bg-gray-50 p-4 rounded-2xl outline-none">
                <button onclick="sendOrder()" class="bg-indigo-600 text-white px-6 rounded-2xl font-bold">G·ª¨I</button>
            </div>
        </div>
        <div id="liveOrders" class="space-y-3"></div>
    </div>

    <div id="staff" class="tab-content space-y-4">
        <div class="bg-white p-6 rounded-[2rem] shadow-sm text-center">
            <h3 class="font-black text-gray-800 mb-4">ƒêI·ªÇM DANH G∆Ø∆†NG M·∫∂T</h3>
            <input type="text" id="staffName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." class="w-full bg-gray-50 p-4 rounded-2xl mb-4 text-center outline-none">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="openCamera('V√ÄO CA')" class="bg-green-500 text-white py-4 rounded-2xl font-bold">V√ÄO CA</button>
                <button onclick="openCamera('TAN CA')" class="bg-red-500 text-white py-4 rounded-2xl font-bold">TAN CA</button>
            </div>
        </div>
        
        <div id="attendanceLog" class="space-y-3">
            </div>
    </div>

    <div id="admin" class="tab-content">
        <div class="bg-white p-6 rounded-[2rem] shadow-sm text-center">
            <p class="text-gray-400 text-xs font-bold uppercase">Doanh thu h√¥m nay</p>
            <h3 id="revVal" class="text-3xl font-black text-indigo-600">0ƒë</h3>
            <div class="mt-6">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

</main>

<footer class="fixed bottom-0 inset-x-0 bg-white border-t p-4 flex justify-around items-center rounded-t-[2rem] z-50 shadow-2xl">
    <button onclick="tab('pos', this)" class="flex flex-col items-center nav-active"><span>‚òï</span><span class="text-[10px]">B√ÅN H√ÄNG</span></button>
    <button onclick="tab('staff', this)" class="flex flex-col items-center text-gray-400"><span>üë§</span><span class="text-[10px]">NH√ÇN VI√äN</span></button>
    <button onclick="tab('admin', this)" class="flex flex-col items-center text-gray-400"><span>üìä</span><span class="text-[10px]">B√ÅO C√ÅO</span></button>
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB-rTmNSqnZ18y15esxbBQko-Gf0TqqmVQ",
        authDomain: "quan-ly-van-hanh.firebaseapp.com",
        databaseURL: "https://quan-ly-van-hanh-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "quan-ly-van-hanh",
        storageBucket: "quan-ly-van-hanh.firebasestorage.app",
        messagingSenderId: "983773797210",
        appId: "1:983773797210:web:155c433149e20c633e3163"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const menu = [{n:'Cafe ƒêen',p:25000},{n:'Cafe S·ªØa',p:30000},{n:'B·∫°c X·ªâu',p:35000},{n:'Tr√† ƒê√†o',p:40000}];
    let currentAction = "";

    // CAMERA LOGIC
    function openCamera(action) {
        if(!document.getElementById('staffName').value) return alert("Vui l√≤ng nh·∫≠p t√™n!");
        currentAction = action;
        document.getElementById('camera-overlay').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(stream => { document.getElementById('video').srcObject = stream; });
    }

    function closeCamera() {
        const stream = document.getElementById('video').srcObject;
        stream.getTracks().forEach(track => track.stop());
        document.getElementById('camera-overlay').style.display = 'none';
    }

    function takePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = 300; canvas.height = 300;
        canvas.getContext('2d').drawImage(video, 0, 0, 300, 300);
        const photoData = canvas.toDataURL('image/jpeg', 0.5); // N√©n ·∫£nh 50% cho nh·∫π
        
        const name = document.getElementById('staffName').value;
        db.ref('attendance').push({
            name,
            action: currentAction,
            photo: photoData,
            time: new Date().toLocaleString('vi-VN')
        });
        
        closeCamera();
        alert("ƒêi·ªÉm danh th√†nh c√¥ng!");
    }

    // TAB & UI
    function tab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active-tab');
        document.querySelectorAll('footer button').forEach(b => b.classList.remove('nav-active'));
        btn.classList.add('nav-active');
    }

    // REALTIME DATA
    db.ref('orders').on('value', snap => {
        const data = snap.val();
        const list = document.getElementById('liveOrders');
        list.innerHTML = ''; let rev = 0;
        if(data) {
            Object.keys(data).reverse().forEach(k => {
                const o = data[k];
                if(o.status === 'done') rev += o.price;
                else list.innerHTML += `<div class="bg-white p-4 rounded-2xl flex justify-between shadow-sm border-l-4 border-indigo-500"><span class="font-bold">${o.name}</span><button onclick="db.ref('orders/${k}').update({status:'done'})" class="text-indigo-600 font-bold text-xs uppercase">Xong</button></div>`;
            });
        }
        document.getElementById('revVal').innerText = rev.toLocaleString() + 'ƒë';
    });

    // NH·∫¨T K√ù ƒêI·ªÇM DANH (C√ì ·∫¢NH)
    db.ref('attendance').limitToLast(10).on('value', snap => {
        const log = document.getElementById('attendanceLog');
        log.innerHTML = '<h4 class="font-bold text-gray-400 text-xs mb-2">NH·∫¨T K√ù M·ªöI NH·∫§T</h4>';
        snap.forEach(child => {
            const v = child.val();
            log.innerHTML += `
                <div class="bg-white p-3 rounded-2xl flex items-center gap-4 shadow-sm">
                    <img src="${v.photo}" class="w-12 h-12 rounded-full object-cover border-2 border-indigo-100">
                    <div>
                        <p class="font-bold text-sm">${v.name} - <span class="${v.action === 'V√ÄO CA' ? 'text-green-500' : 'text-red-500'}">${v.action}</span></p>
                        <p class="text-[10px] text-gray-400">${v.time}</p>
                    </div>
                </div>`;
        });
    });

    function init() {
        const grid = document.getElementById('menuGrid');
        menu.forEach(i => {
            grid.innerHTML += `<button onclick="document.getElementById('customOrder').value='${i.n}'" class="p-3 bg-gray-50 rounded-xl font-bold text-[10px] active:bg-indigo-100">${i.n}</button>`;
        });
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    }

    function sendOrder() {
        const name = document.getElementById('customOrder').value;
        if(!name) return;
        const price = menu.find(m => m.n === name)?.p || 0;
        db.ref('orders').push({ name, price, status: 'pending', timestamp: Date.now() });
        document.getElementById('customOrder').value = '';
    }

    setInterval(() => { document.getElementById('headerTime').innerText = new Date().toLocaleTimeString('vi-VN'); }, 1000);
    init();
</script>
</body>
</html>
